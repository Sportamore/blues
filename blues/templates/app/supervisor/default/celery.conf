{%- if not queues %}

{% extends 'supervisor/default/program.conf' %}
{% block program_name -%}worker{% endblock program_name -%}
{% block program -%}
# Start before celery beat
priority=998
command={{ virtualenv }}/bin/celery worker --app={{ module }} -l info -c {{ workers }}

[group:celery_worker]
programs=worker

{%- endblock program %}


{% else %}

{# Do queues #}
{% for program_name, queue in queues.iteritems() %}
{% include 'supervisor/default/program.conf' %}
command={{ virtualenv }}/bin/celery worker --app={{ module }} -c {{ queue.workers }} -Q {{ program_name }} -E -n {{ program_name}}-worker@%%h -l info
{% endfor %}


{% for extension in extensions %}
{% with program_name=extension %}

{# Do beat #}
{% if extension == 'beat' %}
{% include 'supervisor/default/program.conf' %}
command={{ virtualenv }}/bin/celery beat --app={{ module }} -l info -s {{ beat_schedule|default('/var/run/supervisord/celerybeat-schedule') }}


{# Do celery-flower #}
{% elif extension == 'celery-flower' %}
{% include 'supervisor/default/program.conf' %}
command={{ virtualenv }}/bin/celery flower --app={{ module }} -l warning


{% else %}
# WARNING: Unknown extension {{ extension }}
{% endif %}

{% endwith %}
{% endfor %}


[group:celery]
programs={{ celery_group|join(',') }}

{% endif -%}
